<!DOCTYPE html>
<!--
    Color palette:
    - Background: #0d1117 (deep dark blue)
    - Surface: #21262d (card backgrounds)
    - Border: #30363d (subtle borders)
    - Text: #c9d1d9 (primary text)
    - Accent: #58a6ff (links, highlights)
    - Success: #3fb950 (connected state)
    - Error: #f85149 (disconnected state)
-->
    <style>
        /* ====================================================================
           RESET & BASE STYLES
           ==================================================================== */
        
        /* CSS Reset - Remove default browser styles for consistency */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* Include padding/border in element size */
        }
        
        /* Base body styles */
        body {
            /* Font stack: Prefer monospace fonts for a "terminal" aesthetic */
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            
            /* Gradient background for visual depth */
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            
            /* Light gray text color for readability on dark background */
            color: #c9d1d9;
            
            /* Ensure the page fills at least the viewport height */
            min-height: 100vh;
            
            /* Comfortable padding around content */
            padding: 2rem;
        }
        
        /* ====================================================================
           TYPOGRAPHY
           ==================================================================== */
        
        h1 {
            color: #58a6ff;        /* Blue accent color */
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        /* ====================================================================
           LAYOUT
           ==================================================================== */
        
        /* Main container - centers content and limits max width */
        .container {
            max-width: 800px;
            margin: 0 auto;       /* Center horizontally */
        }
        
        /* ====================================================================
           CONNECTION STATUS INDICATOR
           ==================================================================== */
        
        /* Status bar showing connection state */
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: #21262d;   /* Slightly lighter than body */
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        
        /* Circular status indicator (red = disconnected) */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;    /* Perfect circle */
            background: #f85149;   /* Red = disconnected */
        }
        
        /* Connected state - green with glow effect */
        .status-dot.connected {
            background: #3fb950;   /* Green = connected */
            box-shadow: 0 0 8px #3fb950; /* Subtle glow */
        }
        
        /* ====================================================================
           CANVAS CONTAINER (Step 3)
           ==================================================================== */
        
        /* Canvas wrapper for the packet visualization */
        .canvas-container {
            margin-bottom: 1rem;
            border: 1px solid #30363d;
            border-radius: 6px;
            overflow: hidden;
        }
        
        /* The actual canvas element */
        #packetCanvas {
            display: block;
            background: #0d1117;   /* Dark background */
            width: 100%;           /* Responsive width */
            height: auto;
        }
        
        /* ====================================================================
           PERFORMANCE STATS DISPLAY
           ==================================================================== */
        
        .stats {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: #21262d;
            border-radius: 6px;
            border: 1px solid #30363d;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        
        .stats span {
            color: #8b949e;
        }
        
        .stats strong {
            color: #58a6ff;
            font-weight: bold;
        }
        
        /* ====================================================================
           LOG CONTAINER
           ==================================================================== */
        
        /* Scrollable log area showing connection events */
        .log-container {
            background: #0d1117;   /* Darkest background for contrast */
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            height: 200px;         /* Reduced height to make room for canvas */
            overflow-y: auto;      /* Enable vertical scrolling */
            font-size: 0.9rem;
        }
        
        /* Individual log entries */
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #21262d;
        }
        
        /* Remove border from last entry */
        .log-entry:last-child {
            border-bottom: none;
        }
        
        /* Timestamp styling */
        .log-time {
            color: #8b949e;        /* Muted gray */
            margin-right: 0.5rem;
        }
        
        /* Source label (JS, Rust, WS) */
        .log-source {
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        /* Color-coded source labels */
        .log-source.js { color: #f0e68c; }   /* Yellow for JavaScript */
        .log-source.rust { color: #dea584; } /* Orange for Rust/Wasm */
        .log-source.ws { color: #a5d6ff; }   /* Light blue for WebSocket */
        
        /* ====================================================================
           CONTROL BUTTONS
           ==================================================================== */
        
        .controls {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;           /* Space between buttons */
        }
        
        /* Base button styles */
        button {
            padding: 0.5rem 1rem;
            background: #238636;   /* Green background */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;  /* Use the same monospace font */
            font-size: 0.9rem;
            transition: background 0.2s; /* Smooth hover effect */
        }
        
        /* Button hover state */
        button:hover {
            background: #2ea043;   /* Slightly lighter green */
        }
        
        /* Disabled button state */
        button:disabled {
            background: #21262d;   /* Dark gray */
            color: #8b949e;        /* Muted text */
            cursor: not-allowed;   /* Show "no" cursor */
        }
    </style>
</head>
<body>
    <!-- ====================================================================
         MAIN CONTAINER
         ====================================================================
    -->
    <div class="container">
        <!-- Page title -->
        <h1>ðŸ”Œ WebSocket + Wasm Demo</h1>
        
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
        
        <div class="canvas-container">
            <canvas id="packetCanvas" width="800" height="600"></canvas>
        </div>
        
        <div class="stats" id="statsContainer">
            <span>Packets: <strong id="packetCount">0</strong></span>
            <span>JSON Size: <strong id="jsonSize">0 KB</strong></span>
            <span>Draw Time: <strong id="drawTime">0ms</strong></span>
        </div>
        

        <div class="log-container" id="logContainer"></div>

        <div class="controls">
            <button id="connectBtn">Connect</button>
            <button id="sendBtn" disabled>Send Test</button>
            <button id="clearBtn">Clear Canvas</button>
        </div>
    </div>

    <!-- ====================================================================
         JAVASCRIPT APPLICATION
         ====================================================================
    -->
    <script type="module">
        // =====================================================================
        // IMPORTS
        // =====================================================================
        import init, { 
            handle_message, 
            handle_binary, 
            console_log,
            init_gpu,
            get_memory,
            get_packet_buffer_ptr,
            get_packet_buffer_len,
            allocate_packet_buffer,
            update_packet_buffer_from_binary,
            update_packet_buffer_from_json,
            clear_packet_buffer,
            render_frame
        } from './pkg/simulation.js';
        
        // =====================================================================
        // STATE VARIABLES
        // =====================================================================
        
        let ws = null;
        
        // =====================================================================
        // DOM ELEMENT REFERENCES
        // =====================================================================
        
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const logContainer = document.getElementById('logContainer');
        const connectBtn = document.getElementById('connectBtn');
        const sendBtn = document.getElementById('sendBtn');
        
        const canvas = document.getElementById('packetCanvas');
        
        const packetCountEl = document.getElementById('packetCount');
        const jsonSizeEl = document.getElementById('jsonSize');
        const drawTimeEl = document.getElementById('drawTime');
        const clearBtn = document.getElementById('clearBtn');
        
        let totalPackets = 0;
        let lastJsonSize = 0;
        
        // =====================================================================
        // CANVAS DRAWING FUNCTIONS (Step 3)
        // =====================================================================
        function clearCanvas() {
            totalPackets = 0;
            packetCountEl.textContent = '0';
            drawTimeEl.textContent = '0ms';
            addLog('JS', 'Canvas cleared (WebGPU rendering)');
        }
        
        // =====================================================================
        // SHARED MEMORY ZERO-COPY DRAWING (High Performance)
        // =====================================================================
    
        function drawPacketsFromSharedMemory(packetCount) {
            const startTime = performance.now();
            
            const memory = get_memory();
            
            const ptr = get_packet_buffer_ptr();
            const len = get_packet_buffer_len();
            
            const coords = new Float32Array(memory.buffer, ptr, len);
            
            const drawTime = performance.now() - startTime;
            
            totalPackets += packetCount;
            packetCountEl.textContent = totalPackets;
            drawTimeEl.textContent = drawTime.toFixed(2) + 'ms';
            
            addLog('JS', `Received ${packetCount} packets (rendered by WebGPU)`);
        }
        
        function handleBinaryWithSharedMemory(bytes) {
            const startTime = performance.now();
            
            const packetCount = update_packet_buffer_from_binary(bytes);
            
            const parseTime = performance.now() - startTime;
            
            drawPacketsFromSharedMemory(packetCount);

            addLog('JS', `[Shared Memory] Parse: ${parseTime.toFixed(2)}ms, Packets: ${packetCount}`);
        }
        
        function handleJsonWithSharedMemory(jsonData) {
            const startTime = performance.now();
            
            const packetCount = update_packet_buffer_from_json(jsonData);
            
            if (packetCount === 0) {
                handle_message(jsonData);
                return;
            }
            
            const parseTime = performance.now() - startTime;
            
            drawPacketsFromSharedMemory(packetCount);
            
            addLog('JS', `[Shared Memory JSON] Parse: ${parseTime.toFixed(2)}ms, Packets: ${packetCount}`);
        }
        
        // =====================================================================
        // UTILITY FUNCTIONS
        // =====================================================================
        function addLog(source, message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString('ja-JP');
            
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-source ${source.toLowerCase()}">[${source}]</span>
                <span>${message}</span>
            `;
            
            logContainer.appendChild(entry);
            
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function setConnected(connected) {
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                connectBtn.textContent = 'Disconnect';
                sendBtn.disabled = false;
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                connectBtn.textContent = 'Connect';
                sendBtn.disabled = true;
            }
        }
        
        // =====================================================================
        // WEBSOCKET FUNCTIONS
        // =====================================================================
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
                return;
            }
            
            addLog('JS', 'Connecting to ws://localhost:8080/ws...');
            
            ws = new WebSocket('ws://localhost:8080/ws');
            
            // -------------------------------------------------------------
            // Event: Connection opened
            // -------------------------------------------------------------
            ws.onopen = () => {
                addLog('WS', 'Connection established!');
                setConnected(true);
            };
            
            // -------------------------------------------------------------
            // Event: Message received
            // -------------------------------------------------------------
            ws.onmessage = (event) => {
                if (event.data instanceof Blob || event.data instanceof ArrayBuffer) {
                    event.data.arrayBuffer().then(buffer => {
                        const bytes = new Uint8Array(buffer);
                        handle_binary(bytes);
                    });
                } else {
                    handle_message(event.data);
                }
            };
            
            // -------------------------------------------------------------
            // Event: Connection closed
            // -------------------------------------------------------------
            ws.onclose = () => {
                addLog('WS', 'Connection closed');
                setConnected(false);
            };
            
            // -------------------------------------------------------------
            // Event: Error occurred
            // -------------------------------------------------------------
            // Fired when a WebSocket error occurs
            ws.onerror = (error) => {
                addLog('WS', `Error: ${error.message || 'Connection failed'}`);
            };
        }
        
        /**
         * Sends a test message to the server.
         * 
         */
        function sendTest() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const packetCount = 100;
                const buffer = new ArrayBuffer(packetCount * 8);
                const view = new DataView(buffer);
                
                for (let i = 0; i < packetCount; i++) {
                    const offset = i * 8;
                    const id = i;
                    const x = Math.floor(Math.random() * 65535);
                    const y = Math.floor(Math.random() * 65535);
                    
                    view.setUint32(offset, id, true);
                    view.setUint16(offset + 4, x, true);
                    view.setUint16(offset + 6, y, true);
                }
                
                ws.send(buffer);
                addLog('JS', `Sent ${packetCount} test packets (binary format)`);
            }
        }
        
        // =====================================================================
        // WASM INITIALIZATION
        // =====================================================================
        async function run() {
            try {
                await init();
                
                addLog('JS', 'Wasm module loaded successfully!');
                
                const MAX_PACKETS = 100000;
                allocate_packet_buffer(MAX_PACKETS);
                addLog('JS', `[Shared Memory] Pre-allocated buffer for ${MAX_PACKETS} packets`);
                
                addLog('JS', 'Initializing WebGPU...');
                try {
                    await init_gpu('packetCanvas');
                    addLog('JS', 'WebGPU initialized successfully!');
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
                    function animate() {
                        render_frame();
                        requestAnimationFrame(animate);
                    }
                    requestAnimationFrame(animate);
                    
                } catch (e) {
                    addLog('JS', `WebGPU initialization failed: ${e}`);
                    console.error('WebGPU init error:', e);
                }
                
                console_log('Hello from JavaScript!');
                
            } catch (e) {
                addLog('JS', `Failed to load Wasm: ${e.message}`);
                console.error(e);
            }
        }
        
        // =====================================================================
        // EVENT LISTENERS
        // =====================================================================
        connectBtn.addEventListener('click', connect);
        sendBtn.addEventListener('click', sendTest);
        clearBtn.addEventListener('click', clearCanvas);
        
        // =====================================================================
        // APPLICATION ENTRY POINT
        // =====================================================================
        run();
    </script>
</body>
</html>
